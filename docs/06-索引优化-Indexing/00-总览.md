### 總覽
本模組聚焦「索引優化」三大主線：
- 從小塊到大上下文：用更細粒度構建索引，同時在檢索或回答時補足上下文，兼顧召回與可讀性。
- 構建有層次的索引：以多層索引與能力路由（如 Pandas/子索引）應對結構化數據與場景化查詢。
- 構建多表示的索引：為同一文檔建立多個向量表示（摘要/標題/關鍵詞），提升召回覆蓋與效率。

### 全景關係圖
```mermaid
flowchart TD
  subgraph A[01-從小塊到大上下文]
    A1[節點句子滑動窗口\nSentenceWindow + MetadataReplacement]
    A2[父子文本塊檢索\nParentDocumentRetriever]
    A3[前後向擴展上下文\nPrevNext/AutoPrevNext]
  end

  subgraph B[02-構建有層次的索引]
    B0[直接讀入文檔→索引→問答]
    B1[雙層索引-Milvus v1\n(明細欄位, 較脆弱)]
    B2[雙層索引-Milvus v2\n(整表文本, 穩定)]
    B3[雙層索引-PandasNode\n(RecursiveRetriever)]
    B4[粗中有細\nHierarchical+AutoMerging]
    B5[分層合併示例\nRecursive 路由]
    B8[雙層索引-FAISS\n(本地輕量)]
  end

  subgraph C[03-構建多表示的索引]
    C1[混合檢索\nEnsembleRetriever]
    C2[MultiVectorRetriever\n(摘要/多表示+ByteStore)]
  end

  subgraph D[99-其它測試]
    D1[LlamaParse+MarkdownElementNodeParser+重排]
    D2[camelot/Unstructured + LlamaIndex 表格問答]
  end

  %% 關聯
  A1 --> B4
  A2 --> B3
  A3 --> B4
  B0 --> B3
  B1 --> B2
  B2 --> B5
  B3 --> B5
  B2 --> C2
  C1 --> C2
  D1 --> B4
  D2 --> B3
```

### 模塊說明與建議組合
- 01-從小塊到大上下文
  - 節點句子滑動窗口：精準定位句子，回答時以窗口替換文本，既準確又可讀。
  - 父子文本塊檢索：以子塊建立索引、以父塊回答。高召回 + 好可讀。
  - 前後向擴展上下文：命中片段自動拼接前後文，敘事文本尤佳。

- 02-構建有層次的索引
  - Milvus 雙層（v1→v2）：第一層定位表（sheet/摘要），第二層在表內找答案。v2 改為「整表文本」向量，顯著提升穩定性；v1（行級欄位）對資料清洗依賴強、易脆弱。
  - PandasNode + RecursiveRetriever：向量路由到對應的 PandasQueryEngine，專項處理表格查詢。
  - Hierarchical + AutoMerging：葉節點建索引保召回，自動合併回大段落，提升可讀性。
  - FAISS 雙層：本地輕量無服務依賴，用於原型或資源受限場景。

- 03-構建多表示的索引
  - EnsembleRetriever：BM25+向量融合，對口語/雜訊查詢更穩健。
  - MultiVectorRetriever：為長文創建多段摘要/標題等向量，多視角命中後再從 ByteStore 取回原文。

### 最佳實踐對比表（方法選型）

| 方法 | 適用場景 | 核心優勢 | 成本/延遲 | 風險/注意 |
|---|---|---|---|---|
| SentenceWindow + MetadataReplacement | 知識點密集、句子短小的文本（FAQ/條款） | 精準命中且輸出可讀 | 低 | 需要合適的 window 大小與分句策略 |
| ParentDocumentRetriever | 需要完整上下文回答 | 子塊索引、父塊輸出 | 低-中 | 確保父子映射一致；新增文檔應走 retriever.add_documents |
| PrevNext/AutoPrevNext | 長敘事、章節型文本 | 自動補齊上下文 | 低 | Auto 模式需觀測，避免抓取過多無關上下文 |
| Hierarchical + AutoMerging | 長文/章節層次明確 | 召回葉節點、輸出合併段 | 中 | 需 SimpleDocumentStore 保存節點關係 |
| Milvus 雙層 v2（整表文本） | 多表/多年報表檢索 | 穩定、易維護 | 中 | 表內容需一致格式；可配重排 |
| Milvus 雙層 v1（欄位級） | 欄位語義明確且清洗充分 | 可做字段級問答 | 中-高 | 脆弱、對欄位/清洗敏感，不推薦量產 |
| FAISS 雙層 | 無外部服務、快速原型 | 本地輕量 | 低 | 需自行管理索引持久化與對齊規則 |
| RecursiveRetriever + Pandas | 表格/結構化查詢 | 能力路由到表格引擎 | 中 | 需維護 index_id → 引擎映射與權限 |
| EnsembleRetriever | 查詢口語化/關鍵詞與語義兼具 | 穩健融合 | 低-中 | 權重需校準；可後接重排 |
| MultiVectorRetriever | 長文、跨段落召回 | 多表示提升覆蓋 | 中 | 需維護 id_key 一致性；多表示成本 |
| LlamaParse + MarkdownNode | 複雜 PDF（章節/表格/圖片） | 結構理解 + 重排 | 中-高 | 解析成本高；需重排與觀測 |
| camelot/Unstructured + LlamaIndex | 表格抽取 + 文本索引 | 表格問答可行 | 中 | 表頭與欄位對齊需人工校正 |

### 推薦管線模板（按場景）
- 長段敘事（小說/專題報告）：Hierarchical + AutoMerging →（可疊加）SentenceWindow 替換輸出。
- 長文檔＋綜述型問答：MultiVectorRetriever（摘要/標題）→ ByteStore 還原原文。
- 多年/多表報表：Milvus 雙層 v2 或 FAISS 雙層 →（可選）重排。
- 表格問答：RecursiveRetriever + IndexNode（摘要）→ PandasQueryEngine。
- 查詢噪音較大：EnsembleRetriever（BM25+向量）→（可選）重排。

### 代碼地圖（對應本模組）
- 01-從小塊到大上下文：`01-节点句子滑动窗口.py`、`02-父子文本块检索.py`、`03-前后向扩展上下文.py`
- 02-構建有層次的索引：`00-直接读入文档，索引，并问答.py`、`01-双层索引-Milvus-能跑但是不成熟版.py`、`02-双层索引-Milvus-成功的分层索引.py`、`03-双层索引-PandasNode.py`、`04-粗中有细的示例.py`、`05-分层合并的示例.py`、`98-双层索引-FAISS.py`、`99-查询测试.py`
- 03-構建多表示的索引：`01-用EnsembleRetriever做混合检索.py`、`02-用MultiVectorRetriever构建多表示索引.py`
- 99-其它測試：`llamaparsePDF问答.py`、`camelot+llamaindex表格问答.py`、`Unstructured+llamaindex表格问答.py`

### 關鍵點總結
- 召回與可讀性的折衷：索引粒度做小，回答時做大（父子/AutoMerging/窗口替換）。
- 能力路由是關鍵：IndexNode + RecursiveRetriever 讓表格/特種引擎各司其職。
- 多表示勝於單向量：摘要/標題/關鍵詞並存，覆蓋更全面，成本可控。
- 對資料脆弱性保持警惕：欄位級方案（Milvus v1）慎用，優先整表文本或摘要向量。


