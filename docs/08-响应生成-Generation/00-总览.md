### 總覽
本模組覆蓋「模型調用/微調、提示工程、輸出解析、動態優化」四條主線，目標是在 RAG 的最終生成階段，輸出準確、可控、結構化且具穩健性的回覆。

### 模塊關係圖
```mermaid
flowchart TD
  subgraph M[01 模型的選擇與調用]
    M1[使用Qwen3] --> M2[微調Qwen3]
  end

  subgraph P[02 提示詞優化]
    P1[明確生成目標] --> P2[Few-Shot 參考]
    P2 --> P3[多樣性/全面性提升]
    P3 --> P4[路由選模板 + 案例檢索]
  end

  subgraph O[03 輸出解析/結構化]
    O1[LangChain JSON 解析] --> O2[LlamaIndex 多模式輸出]
    O2 --> O3[JSON 輸出(模型原生)]
    O3 --> O4[Pydantic v1 驗證]
    O4 --> O5[Pydantic v2 直出模型]
    O1 --> O4
  end

  subgraph S[04 動態生成優化]
    S1[Self-RAG: 檢索評分/幻覺評分/答案評分/重寫]
  end

  M --> P --> O --> S
```

### 方法對比表（生成階段關鍵策略）

| 類別 | 方法 | 優勢 | 成本/延遲 | 適用場景 |
|---|---|---|---|---|
| 模型 | 小模型直推 | 成本低、啟動快 | 低 | Demo/測試/離線批處理 |
| 模型 | 指令微調 | 對齊任務表現穩定 | 中 | 特定領域/格式對齊 |
| 提示 | 明確欄位模板 | 輸出一致可解析 | 低 | 報告/表單/規範性文本 |
| 提示 | Few-Shot | 對齊風格與結構 | 低-中 | 類比輸出、風格遷移 |
| 提示 | 意圖路由+案例檢索 | 針對性高、可操作 | 中 | 多場景任務中心化平台 |
| 輸出 | 原生 JSON 輸出 | 解析穩定 | 低 | API 集成、前後端通訊 |
| 輸出 | Pydantic v2 直出 | 類型安全、零解析 | 低-中 | 嚴格結構化輸出 |
| 優化 | Self-RAG | 可糾偏、可觀測 | 中-高 | 高可靠回覆要求 |

### 推薦組合
- 報表/審計/工單：檢索 → 模板化提示 → 原生 JSON → Pydantic 校驗。
- 複雜問答/專家系統：檢索 → Few-Shot + 路由模板 → 多模式輸出（表格/分點）→ Self-RAG。
- 開發輔助：小模型直推 → JSON 控制 → 必要時指令微調對齊風格。

### 代碼地圖
- 模型：`01-模型的选择和调用/01-使用Qwen3.py`、`02-微调Qwen3.py`
- 提示：`02-通过提示词优化响应/01-04*.py`
- 輸出：`03-通过输出解析控制格式/01-05*.py`
- 優化：`04-动态生成优化策略/Self-RAG完整实现.py`


